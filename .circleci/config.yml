version: '2.1'
orbs:
  terraform: circleci/terraform@3.1
  aws-cli: circleci/aws-cli@2.0.6
  tfsec: mycodeself/tfsec@1.1.0
jobs:
  tfsec:
    parameters:
    executor: tfsec/default
    steps:
      - checkout
      - tfsec/scan: 
          directory: ./infrastructure
          exclude-checks: 'aws-ec2-no-public-egress-sgr,aws-ec2-no-public-ingress-sgr,aws-ec2-enable-at-rest-encryption,aws-ec2-enforce-http-token-imds,aws-ec2-require-vpc-flow-logs-for-all-vpcs'

  aws-cli-cred-setup:
    executor: aws-cli/default
    steps:
      - aws-cli/setup:
          aws-access-key-id: AWS_ACCESS_KEY
          aws-secret-access-key: AWS_ACCESS_SECRET
          aws-region: AWS_REGION_NAME
  single-job-lifecycle:
    executor: terraform/default
    steps:
      - checkout
      - terraform/init:
          path: infrastructure/
      - terraform/validate:
          path: infrastructure/
      - terraform/plan:
          path: infrastructure/
      - terraform/apply:
          path: infrastructure/
      - terraform/destroy:
          path: infrastructure/
    working_directory: ~/src
workflows:
  single-job-lifecycle:
    jobs:
      - tfsec
      - aws-cli-cred-setup:
          context: aws
      - single-job-lifecycle:
          requires:
            - aws-cli-cred-setup